/*
Module: logs-from-api
Description: Performs Kubernetes service discovery for pods, applies relabelings, the discovered target logs are
             then retrieved from the kubernetes api
Arguments:
  forward_to: Module to forward the output to
*/
argument "forward_to" {
  optional = false
}

argument "git_repo" {
  optional = true
  default = coalesce(env("GIT_REPO"), "https://github.com/grafana/agent-modules.git")
}

argument "git_rev" {
  optional = true
  default = coalesce(env("GIT_REV"), env("GIT_REVISION"), env("GIT_BRANCH"), "main")
}

discovery.kubernetes "pods" {
  role = "pod"
}

module.git "relabelings_log" {
  repository = argument.git_repo.value
  revision   = argument.git_rev.value
  path = "modules/kubernetes/logs/relabelings.river"

  arguments {
    targets = discovery.kubernetes.pods.targets
  }
}

loki.source.kubernetes "pods" {
  targets    = module.git.relabelings_log.exports.relabelings.output
  forward_to = [argument.forward_to.value]
}
